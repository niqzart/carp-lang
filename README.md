# Лабораторная работа №3 по Архитектуре компьютера

- Нестеров Николай Константинович
- `lisp | risc | harv | hw | instr | struct | stream | mem | prob2`

## Язык программирования
CARP — Creative ARRay Processor

## Организация памяти

## Система команд
### Особенности процессора
- машинное слово 32-битное, знаковое
- ввод-вывод размаплен на память, запись в ячейки 0 - 15 обращается к внешним устройствам
- прерывания не реализованы за ненадобностью

#### Регистры
| код |      название       |        тип        |                      назначение                       |
|:---:|:-------------------:|:-----------------:|:-----------------------------------------------------:|
|  A  |     accumulator     | общего назначения |          участие в арифметических операциях           |
|  B  |       buffer        | общего назначения |          участие в арифметических операциях           |
| MP  |   memory pointer    |     адресный      |     хранит адрес памяти данных для операций с ней     |
| IP  | instruction pointer |     адресный      |     хранит адрес памяти команд следующей команды      |
| CD  |    command data     |      особый       |          хранит текущую исполняемую команду           |
|  Z  |      zero flag      |       флаг        |       был ли результат последнего вычисления 0?       |
|  N  |    negative flag    |       флаг        | был ли результат последнего вычисления отрицательным? |

### Набор инструкций
#### Работа с памятью
| название | аргумент1 |    аргумент2    |               описание                |
|:--------:|:---------:|:---------------:|:-------------------------------------:|
|   load   |  Регистр  |      Адрес      | Загружает данные из памяти в регистр  |
|   save   |  Регистр  |      Адрес      | Сохраняет данные из регистра в память |
|   grab   |  Регистр  |                 | Достаёт элемент с вершину стека (pop) |
|   push   |  Регистр  |                 |  Складывает элемент на вершину стека  |

#### Математические операции
| название | аргумент1 (A) |  аргумент2 (B)  |            результат             |
|:--------:|:-------------:|:---------------:|:--------------------------------:|
|   add    |    Регистр    | Регистр / Число |           `A = A + B`            |
|   sub    |    Регистр    | Регистр / Число |           `A = A - B`            |
|   mul    |    Регистр    | Регистр / Число |           `A = A * B`            |
|   div    |    Регистр    | Регистр / Число | `A = A / B` (только целая часть) |
|   mod    |    Регистр    | Регистр / Число |   `A = A / B`(только остаток)    |
|   cmp    |    Регистр    | Регистр / Число |    Выставить флаги по `A - B`    |
|   pmc    |    Регистр    | Регистр / Число |    Выставить флаги по `B - A`    |
|   mov    |    Регистр    | Регистр / Число |             `A = B`              |

#### Операции перехода
| название | аргумент1 |  аргумент2   |               описание                |
|:--------:|:---------:|:------------:|:-------------------------------------:|
|    jz    |  Offset   |              |   Переход, если выставлен флаг Zero   |
|    jn    |  Offset   |              | Переход, если выставлен флаг Negative |
|    jb    |  Offset   |              |          Безусловный переход          |

Переходим на offset (целое число), причём так как переходы происходят после выборки команды зациклиться можно запустив `jb -1`

### Способ кодирования инструкций
- Сериализуются в список json-объектов
- Т.к. память инструкции отдельна, нумерация идёт с нуля
- Общая структура инструкции (полная [json-schema](./docs/operation-schema.json)):

```json5
{
  "code": "mov",  // строчной код инструкции из таблиц выше
  "left": {  // первый (левый) аргумент [работа с памятью или математика]
    "type": "registry",  // в виде регистра
    "code": "A"  // A или B
  },
  "right": {  // второй (правый) аргумент [только математические]
    "type": "value",  // в виде значения
    "code": 4000000,  // целое число
  },
  "address": 16,  // абсолютный адрес в памяти, к которому обращаются [только работа с памятью]
  "offset": -4,  // целое число-offset для перехода [только переходы]
}
```
